---
title: "Maths Grades Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
editor_options:
  chunk_output_type: inline
chunk_output_type: inline
---
```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
library(tidyverse)
```

```{r,echo=FALSE}
Name <- c("Annabelle Griffith-Topps","Jake White","Bryan Li","Ana Klabjan","Zi Hern Wong","Jacob Larget")
NetID <- c("griffithtopp","jtwhite4","bli378","aklabjan","zwong4","jlarget")
data.frame(Name,NetID)
```
## Abstract
Our data set describes 395 students, their math grades for a given semester, recorded on three occasions, as well as generic and consistent demographic information. With this data, we created models to answer two statistical questions: (1) What variables have an effect on weather a student will drop out or not? (2) What variables have an effect on predicting a students final grade? 

To_do: conclusion

## Data Set Introduction
This data is important as in the case of our data Portugal they have a high failure rate in core classes compared to other European countries. If we can identify the students who are most likely to drop out after first quarter then teachers and the school systems can provide additional resources to the student. 

The data comes from schools in Portugal through school records as well as questionnaires. This data was collected by Paulo Cortez and Alice Silva who work for the department of Information Systems/Algoritmi R&D Centre at the University of Minho. It started off as two datasets, one with student grades and another with the student questionnaire responses. It was then combined before doing analysis. This study is significant as specifically in Portugal, the proportion of students leaving class early is 40% whereas the average in the rest of the European Union is 15%. This is just one example of a statistic where Portugal is near the bottom compared to the rest of the European Union. Pinpointing a few of these factors could help officials develop a solution to improve Portugal’s educational performance.

The following are the variables available in our dataset. We have bolded those we expect to use as explanatory variables. We are bolding most of the variables because we want to resist the urge to determine the model because it is run. We anticipate being able to use forward and backward stepwise selection.

school - student's school (binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira)
We can train our model on one of the schools to use it to test the squared residuals on the other school. This will allow us to see whether our dataset will be appropriate for all schools or whether one school is just harder than the other.

__sex__ - student's sex (binary: 'F' - female or 'M' - male)
*We know that girls tend to get higher grades than boys in primary school (nytimes.com/2019/02/07/opinion/sunday/girls-school-confidence.html#:~:text=From%20elementary%20school%20through%20college,Girls%20consistently%20outperform%20boys%20academically.) so potentially there could be a correlation between sex and grades in secondary school.

__age__ - student's age (numeric: from 15 to 22)
We are not sure if age will matter but are thinking of including it anyway in case it is helpful for stepwise selection.

__address__ - student's home address type (binary: 'U' - urban or 'R' - rural)
Students might face different challenges living in the city (for instance, higher crime, louder environments, more places near their houses to do work), or living in a rural environment (further away from places like parks, grocery stores, libraries, after school jobs/programs)

__famsize__ - family size (binary: 'LE3' - less or equal to 3 or 'GT3' - greater than 3)
Smaller families might be able to help their children more individually and could help children understand concepts that they might struggle with.

__Pstatus__ - parent's cohabitation status (binary: 'T' - living together or 'A' - apart)
Divorce can be stressful on children and have negative effects. 

__Medu__ - mother's education (numeric: 0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education)
Parents with higher education could influence their student’s performance in school

__Fedu__ - father's education (numeric: 0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education)
Parents with higher education could influence their student’s performance in school

Mjob - mother's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other') create for each its own coefficient
If a student has a working mother, this could impact child performance. Additionally, if a mother is a teacher, the student might perform better and be discouraged to drop out. If a mother works in health care, she likely has a college education, so this might inspire the student to stick with their education and perform better. If a child has a stay-at-home mom, this could have a positive correlation with performance since the mother likely has more of a role in their child’s education than a working mother. There might also be a correlation between student performance and working mothers. 

Fjob - father's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other')
Society expects fathers to be the breadwinner for the family. A stay-at-home father might impact their student’s performance positively and could be able to support their child with schoolwork and encourage them to stay in school. If a father is a teacher, this might encourage the student to do better in school and stay in school. If a father works in health care, this could encourage students to do well and stay in school. 

reason - reason to choose this school (nominal: close to 'home', school 'reputation', 'course' preference or 'other')
A student who chose a school because of the school’s reputation or course preference likely wants to perform well and will stay in school longer. If the only reason that a student chose a school is because it is close to home, they might not feel as connected to the school and not enjoy their studies and perform well in school.

guardian - student's guardian (nominal: 'mother', 'father' or 'other')
If a student’s guardian is not their mother or father, this likely means that the student has grown up in a different dynamic than other students and could impact their performance. This variable doesn’t provide us with much relevant information- a better factor, in our opinion, is seeing if a student’s parents are married or divorced.

__traveltime__ - home to school travel time (numeric: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour)
Longer travel times have general correlation with earlier bedtimes, which then might affect study time in the evening.

__studytime__ - weekly study time (numeric: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours)
Longer study times are generally correlated with higher grades because students are able to comprehend more of the material. Conversely, a student might overstudy and become less confident with the material or waste time when they have mastered the material. 

__failures__ - number of past class failures (numeric: n if 1<=n<3, else 4)
If a student has failed in the past, they may be more likely to fail in the future

schoolsup - extra educational support (binary: yes or no)
This is not clear enough for us. Does it mean a college tutoring service, scholarship or free and reduced lunch? If this variable was more clear, it could be more useful. For instance, if this variable indicates that a student is in a gifted and talented program, they likely perform well and won’t drop out. If a student is in special education, this might have a negative correlation on grades and the student might be more likely to drop out. If this means that a student goes to peer tutoring or asks teachers for help, that might have a positive effect.  Because this information is not accessible, we will not be using this variable. 

famsup - family educational support (binary: yes or no)
This binary is also unclear for similar reasons. This could mean that a student has a private tutor financed by the family, or it could mean that a student might ask their parents for help on a math problem for example. This is a very wide range, and the paid variable would make more sense and could be used effectively. 

__paid__ - extra paid classes within the course subject (Math or Portuguese) (binary: yes or no)
Extra assistance comprehending the material may impact a student’s performance in the course. If a student has access to a private tutor or a summer course, this could positively impact student performance. 

__activities__ - extracurricular activities (binary: yes or no)
Students who are actively involved in school activities might tend to perform better than students who do not participate. They might benefit from a sense  of community that could help them perform better. Conversely, this leaves less time for students to study so it could have a negative impact on performance.

__nursery__ - attended nursery school (binary: yes or no)
The years a student is in nursery are very important for development and this could have a lasting impact on student performance.

__higher__ - wants to take higher education (binary: yes or no)
Students who want to enroll in higher education generally try harder in school to get into a better college.

__internet__ - Internet access at home (binary: yes or no)
Lack of internet might have a negative impact on student performance. The internet can often be a useful resource for students to use (for instance, Khan Academy or Crash Course might be able to help students understand concepts more deeply). 

__romantic__ - with a romantic relationship (binary: yes or no)
Students in a romantic relationship might have less time to spend on homework and studying. Additionally, they might tend to support each other academically. 

__famrel__ - quality of family relationships (numeric: from 1 - very bad to 5 - excellent)
Students who have a supportive relationship with their family might tend to do better, or if they have an unsupportive relationship, they might seek academic validation or want to do well to be able to go to a college with a good scholarship.

__freetime__ - free time after school (numeric: from 1 - very low to 5 - very high)
More free time may impact school results either positively or negatively because students may spend more of their free time studying or hanging out with friends

__goout__ - going out with friends (numeric: from 1 - very low to 5 - very high)
Students might prioritize spending time with friends rather than studying and doing homework and this could lead to a negative impact on grades. 

__Dalc__ - workday alcohol consumption (numeric: from 1 - very low to 5 - very high)
Students who drink alcohol during the week might struggle with addiction and this could lead to negative impact on grades. 

__Walc__ - weekend alcohol consumption (numeric: from 1 - very low to 5 - very high)
Creation of alcohol consumption habits over the weekend are known to work its way into the workweek, which can affect school performance.

__health__ - current health status (numeric: from 1 - very bad to 5 - very good)
If a student has poor health, they might stay home from school more and have to miss class for appointments etc, this could lead to lower grades in theory. 

__absences__ - number of school absences (numeric: from 0 to 93)
The number of absences can correlate with student performance.


```{r,warning=FALSE}
library(tidyverse)
library(formattable)
data <- read.csv("student-mat.csv")
head(data,3)
```

We choose our two questions after some exploratory data analysis where we realized that dropping out resulted in clustering that ran counter to our otherwise confirmed expectation that grades are highly correlated with each other within a given student and semester.

When we first started we ran a pairs plot on our data just based on grades we noticed there was a distinct pattern of several data points in a line that didn't fit the trend of the rest of the data. We indicated these data points in red.
```{r}
grades <- data %>% select(G1,G2,G3)
cols <- character(nrow(grades))
cols[] <- "black"
cols[grades$G3 == 0] <- "red"
pairs(grades,col=cols)
cor(grades)
```
We noticed that there is a strong linear correlation between G1, G2 and G3 grades. We also were able to come to the conclusion that the outlier data points represented students who dropped out of school before the end of the year. The trend lead us to the creation of our first question. 

# Q1: Modeling Student Drop Out Behavior

Transformed data by adding column to indicate if the student dropped out or not.
```{r}
drop <- data %>%
  mutate(dropped = case_when(
    G3 == 0 ~ 1,
    G3 > 0 ~ 0),
    G1=G1/20,G2=G2/20,G3=G3/20) %>%
  select(dropped,G1,G2,G3,everything())
head(drop,3)
```

What variables have an effect on weather a student will drop out?

```{r}
drop %>% group_by(dropped) %>% summarise(count = n()) %>%
  mutate(freq = formattable::percent(count / sum(count)))
```

This question is important to ask since if we can identify which students are most likely to drop out then analysis can be done on future students and those students who are most likely in danger of dropping out can receive access and resources to additional assistance. This is especially important to our data set when the Portuguese are trying to improve there student failure rate in core classes. Our data set shows that at the time of data collection there was about a 10% drop out rate which is very high. 

```{r}
drop %>%
  filter(dropped == 1) %>%
  ggplot(aes(G1)) +
  geom_bar() +
  xlab("First Period Grade in Percentage") +
  ylab("Student Count") +
  ggtitle("First Period Grades Among Students Who Dropped")
```

From these two graphs, we can see that among those who dropped at some point in the class, none of them were able to obtain a score higher than ~60%. Now, how does that relate to students who did not drop?

```{r}
ggplot(drop, aes(x=G1, group=dropped, fill=dropped)) +
  geom_density(alpha=.25) +
  xlab("First Period Grade in Percentage") +
  ylab("Density") +
  ggtitle("First Period Grade Density By Dropped Out")

ggplot(drop,aes(x=dropped, y=G1,group=dropped,fill=dropped)) + 
  geom_boxplot() +
  ggtitle("First Period Grade Distribution by Dropped Out")+
  xlab("Students Dropped Out By End of Year")+
  ylab("First Period Grade in Percentage")
```
Compared to students who did not drop the class, we see a noticeable difference between first period grades. While only the highest scoring students among the dropped category were able to score ~60%, the mean of all student's scores during the first period was ~60%. Thus, we can conclude that students that dropped the class can be predicted to do considerably worse than those who did not drop the class. This seems pretty obvious, but could there be other factors that lead to this outcome?

Now lets create a model with dropped as the response variable and G1 grade as the explanatory variable. 
```{r}
predictDropOut <- glm(dropped~G1, data=drop, family="binomial")
summary(predictDropOut)
predict(predictDropOut, newdata=data.frame(G1=0.35), type="response")
```
We see that G1 is statistically significant at predicting if a student will drop out or not. 
Based on the first graph we see the averaged drop out grade seems to be around 35% when putting that into our model we get that our predicted percentage of dropping out is 24%. I was expecting this value to be higher. Maybe other factors can be included for a better prediction. Also how does the distribution of percentages look for our data?


```{r}
data1 = data %>% mutate(dropped = case_when(
  G3 == 0 ~ 1,
  TRUE ~ 0
)) %>% select(-G1,-G2,-G3)

```

We created a model with dropped as response and everything else in our dataset as the explanatory variables.
```{r warning=FALSE, results=FALSE}
# model creation
m1 = glm(dropped~.,data1, family = "binomial")

m1_AIC = step(m1, scope=dropped~.)
summary(m1)
sum(residuals(m1)^2)
extractAIC(m1)
```
This model has health, weekend drinking, past class failures, mother's education, age and school as being statistically significant when it comes to weather a student will drop out or not. This model has a degrees of freedom of 40 and AIC of 144.67 and RSS 64.67.

We improved the model by using stepwise selection according to AIC.
```{r}
summary(m1_AIC)
sum(residuals(m1_AIC)^2)
# source: https://astrostatistics.psu.edu/su07/R/html/stats/html/extractAIC.html
# output = (equivalent degrees of freedom, generalized Akaike Information Criterion)
extractAIC(m1_AIC)
```
This model has school, age, family size, past class failures, weekend drinking, attending nursery school and romantic partner as being statistically significant weather someone will drop out. This model has a degrees of freedom of 17 and AIC of 110.91 and RSS 110.91.



# Q2: Modeling Completing Students' Semester Performance


```{r}
lmG1 <- lm(G3~G1,data = grades)
lmG2 <- lm(G3~G2,data = grades)
pc <- prcomp(grades[,c(1,2)], scale=TRUE)
lm <- lm(grades$G3 ~ pc$x[,1])
summary(lmG1)
summary(lmG2)
summary(lm)
```

```{r}
sum(residuals(lm)^2)
sum(residuals(lmG1)^2)
sum(residuals(lmG2)^2)
```
```{r}
plot(residuals(lm),xlab="Data Entry Index", ylab="Residual of Lm(G3~PC1)")
abline(h=0,col = "red")
```
There seems to be a strong correlation between the grades students had at the beginning of the year, the middle and the end. This was expected from our data. A linear model seems to be appropriate although when looking at the residual graph there are several outliers on the negative end. This is a pattern to further explore.
```{r}
plot(residuals(lm),xlab="Data Entry Index", ylab="Residual of Lm(G3~PC1)",col = cols)
abline(h=0,col = "red")
```
Based on the graphs above we are able to explain the data points that go against the trend of our data. The points in red represent students who got a 0 for their end of the year grade. We can assume those people dropped out after G1 or G2 was reported.

```{r}
data2 = data %>% filter(G3 != 0) %>% select(-G1,-G2)
data2 %>% 
  ggplot(aes(x=sex, y=G3,fill=sex)) + 
    geom_boxplot() +
  ggtitle("Final Grades Based On Gender")+
  xlab("Gender(F=Female,M=Male)")+
  ylab("End Of Year Grade")
```

We see that on average males performed better in the math course over females. Being a male is more likely to lead to higher grades.

```{r}
data %>%
  ggplot(aes(x=famsup, y=G3,fill=famsup)) + 
    geom_boxplot() +
  ggtitle("Final Grades Based On Family Education Support")+
  xlab("Recieved Family Education Support")+
  ylab("End Of Year Grade")
```

This was surprising as we would have assumed if students received help at home they would receive higher grades due to that extra assistants. Our boxplot shows that both groups have the same average grade. The students who didn't receive help had a greater variety in Q3 and The students who did receive help on the other hand had greater variety in Q2. This being said we came to the conclusion that recieving help a home has minimal impact on final grades. 

```{r}
data %>% mutate(studytime = case_when(studytime == 1 ~ "<15 min",
                                      studytime == 2 ~ "<30 min",
                                      studytime == 3 ~ "<60 min",
                                      TRUE ~ "<60+ min")) %>% 
  ggplot(aes(x=studytime, y=G3,fill=studytime)) + 
    geom_boxplot() +
  ggtitle("Final Grades Based Weekly Study Time")+
  xlab("Weekly Study Time")+
  ylab("End Of Year Grade")
```

When looking at this graph we observed that as study time increases so does the average grade although overstudying can be a thing. Over an hour studying was still relatively comparable to 30min-1 hour studying by median but the lower 50 percent was spread out over a greater region on the other hand the top percentile received a higher grade then the top percentile of people who studied 30 minutes to an hour. Given this information we would say that 30 minutes to an hour is the optimal study time per week for this math course.


```{r}
# this is the subset of data that describes completing students' demographics 
data2 = data %>% filter(G3 != 0) %>% select(-G1,-G2)
#data2
```

```{r, results=FALSE}
m2 = lm(G3~.,data2)
m2_AIC = step(m2,scope=G3~.)
```

After using R's step function to evaluate our model with respect to the deafault AIC^[https://www.r-bloggers.com/2018/04/how-do-i-interpret-the-aic/], we see the following difference in summaries. Notably, using stepwise selection with AIC has highlighted a particular subset of variables worthy of further analysis.

```{r}
summary(m2)
summary(m2_AIC)
```
We can go further by considering the interactions of our variables.

```{r}
# considering a further subset of those deemed important by initial model, will now consider pairwise interactions
data2_pw = data2 %>% select(studytime, failures, schoolsup, goout, health, absences, G3)

#data2_pw
```

```{r, results=FALSE}
m2_pw = lm(G3~(.)^2,data2_pw)
m2_pw_AIC = step(m2_pw, scope=G3~(.)^2)
```

```{r}
summary(m2_pw)
summary(m2_pw_AIC)
```

```{r}
data_final = data2_pw %>% select(-health,-goout)

model_final = lm(G3~(.)^2,data_final)
summary(model_final)
```


Through this progression, you can see how we were able to flatten the residual vs fitted values curve through the AIC, improving our model's predictive ability and isolating a key number of demographic features.

```{r}
plot(m2, which=1)
plot(m2_AIC, which=1)
plot(m2_pw, which=1)
plot(m2_pw_AIC, which=1)
plot(model_final, which=1)

sum(residuals(m2)^2)
sum(residuals(m2_AIC)^2)
sum(residuals(m2_pw)^2)
sum(residuals(m2_pw_AIC)^2)
sum(residuals(model_final)^2)

# source: https://astrostatistics.psu.edu/su07/R/html/stats/html/extractAIC.html
# output = (equivalent degrees of freedom, generalized Akaike Information Criterion)
extractAIC(m2)
extractAIC(m2_AIC)
extractAIC(m2_pw)
extractAIC(m2_pw_AIC)
extractAIC(model_final)
```
