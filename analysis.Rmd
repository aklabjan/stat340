---
title: "Maths Grades Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
editor_options:
  chunk_output_type: inline
chunk_output_type: inline
---
```{r,echo=FALSE}
Name <- c("Annabelle Griffith-Topps","Jake White","Bryan Li","Ana Klabjan","Zi Hern Wong","Jacob Larget")
NetID <- c("griffithtopp","jtwhite4","bli378","aklabjan","zwong4","jlarget")
data.frame(Name,NetID)
```
The following are the variables available in our dataset. We have bolded those we expect to use as explanatory variables, italicized those we expect can be used as response variables, and striked through those we do not expect to use. We are bolding most of the variables because we want to resist the urge to determine the model because it is run. We anticipate being able to use forward and backward stepwise selection.

__school__ - student's school (binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira)
We can train our model on one of the schools to use it to test the squared residuals on the other school. This will allow us to see whether our dataset will be appropriate for all schools or whether one school is just harder than the other.

__sex__ - student's sex (binary: 'F' - female or 'M' - male)
*We know that girls tend to get higher grades than boys in primary school (nytimes.com/2019/02/07/opinion/sunday/girls-school-confidence.html#:~:text=From%20elementary%20school%20through%20college,Girls%20consistently%20outperform%20boys%20academically.) so potentially there could be a correlation between sex and grades in secondary school.

__age__ - student's age (numeric: from 15 to 22)
We are not sure if age will matter but are thinking of including it anyway in case it is helpful for stepwise selection.

__address__ - student's home address type (binary: 'U' - urban or 'R' - rural)
Students might face different challenges living in the city (for instance, higher crime, louder environments, more places near their houses to do work), or living in a rural environment (further away from places like parks, grocery stores, libraries, after school jobs/programs)

__famsize__ - family size (binary: 'LE3' - less or equal to 3 or 'GT3' - greater than 3)
Smaller families might be able to help their children more individually and could help children understand concepts that they might struggle with.

__Pstatus__ - parent's cohabitation status (binary: 'T' - living together or 'A' - apart)
Divorce can be stressful on children and have negative effects. 

__Medu__ - mother's education (numeric: 0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education)
Parents with higher education could influence their student’s performance in school

__Fedu__ - father's education (numeric: 0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education)
Parents with higher education could influence their student’s performance in school

__Mjob__ - mother's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other') create for each its own coefficient
If a student has a working mother, this could impact child performance. Additionally, if a mother is a teacher, the student might perform better and be discouraged to drop out. If a mother works in health care, she likely has a college education, so this might inspire the student to stick with their education and perform better. If a child has a stay-at-home mom, this could have a positive correlation with performance since the mother likely has more of a role in their child’s education than a working mother. There might also be a correlation between student performance and working mothers. 

__Fjob__ - father's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other')
Society expects fathers to be the breadwinner for the family. A stay-at-home father might impact their student’s performance positively and could be able to support their child with schoolwork and encourage them to stay in school. If a father is a teacher, this might encourage the student to do better in school and stay in school. If a father works in health care, this could encourage students to do well and stay in school. 

__reason__ - reason to choose this school (nominal: close to 'home', school 'reputation', 'course' preference or 'other')
A student who chose a school because of the school’s reputation or course preference likely wants to perform well and will stay in school longer. If the only reason that a student chose a school is because it is close to home, they might not feel as connected to the school and not enjoy their studies and perform well in school.

__guardian__ - student's guardian (nominal: 'mother', 'father' or 'other')
If a student’s guardian is not their mother or father, this likely means that the student has grown up in a different dynamic than other students and could impact their performance. This variable doesn’t provide us with much relevant information- a better factor, in our opinion, is seeing if a student’s parents are married or divorced.
__traveltime__ - home to school travel time (numeric: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour)
Longer travel times have general correlation with earlier bedtimes, which then might affect study time in the evening.
__studytime__ - weekly study time (numeric: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours)
Longer study times are generally correlated with higher grades because students are able to comprehend more of the material. Conversely, a student might overstudy and become less confident with the material or waste time when they have mastered the material. 
__failures__ - number of past class failures (numeric: n if 1<=n<3, else 4)
If a student has failed in the past, they may be more likely to fail in the future
__schoolsup__ - extra educational support (binary: yes or no)
This is not clear enough for us. Does it mean a college tutoring service, scholarship or free and reduced lunch? If this variable was more clear, it could be more useful. For instance, if this variable indicates that a student is in a gifted and talented program, they likely perform well and won’t drop out. If a student is in special education, this might have a negative correlation on grades and the student might be more likely to drop out. If this means that a student goes to peer tutoring or asks teachers for help, that might have a positive effect.  Because this information is not accessible, we will not be using this variable. 
__famsup__ - family educational support (binary: yes or no)
This binary is also unclear for similar reasons. This could mean that a student has a private tutor financed by the family, or it could mean that a student might ask their parents for help on a math problem for example. This is a very wide range, and the paid variable would make more sense and could be used effectively. 
__paid__ - extra paid classes within the course subject (Math or Portuguese) (binary: yes or no)
Extra assistance comprehending the material may impact a student’s performance in the course. If a student has access to a private tutor or a summer course, this could positively impact student performance. 
__activities__ - extracurricular activities (binary: yes or no)
Students who are actively involved in school activities might tend to perform better than students who do not participate. They might benefit from a sense  of community that could help them perform better. Conversely, this leaves less time for students to study so it could have a negative impact on performance.
__nursery__ - attended nursery school (binary: yes or no)
The years a student is in nursery are very important for development and this could have a lasting impact on student performance.
__higher__ - wants to take higher education (binary: yes or no)
Students who want to enroll in higher education generally try harder in school to get into a better college.
__internet__ - Internet access at home (binary: yes or no)
Lack of internet might have a negative impact on student performance. The internet can often be a useful resource for students to use (for instance, Khan Academy or Crash Course might be able to help students understand concepts more deeply). 
23 romantic - with a romantic relationship (binary: yes or no)
Students in a romantic relationship might have less time to spend on homework and studying. Additionally, they might tend to support each other academically. 
24 famrel - quality of family relationships (numeric: from 1 - very bad to 5 - excellent)
Students who have a supportive relationship with their family might tend to do better, or if they have an unsupportive relationship, they might seek academic validation or want to do well to be able to go to a college with a good scholarship.
25 freetime - free time after school (numeric: from 1 - very low to 5 - very high)
More free time may impact school results either positively or negatively because students may spend more of their free time studying or hanging out with friends
26 goout - going out with friends (numeric: from 1 - very low to 5 - very high)
Students might prioritize spending time with friends rather than studying and doing homework and this could lead to a negative impact on grades. 
27 Dalc - workday alcohol consumption (numeric: from 1 - very low to 5 - very high)
Students who drink alcohol during the week might struggle with addiction and this could lead to negative impact on grades. 
28 Walc - weekend alcohol consumption (numeric: from 1 - very low to 5 - very high)
Creation of alcohol consumption habits over the weekend are known to work its way into the workweek, which can affect school performance.
29 health - current health status (numeric: from 1 - very bad to 5 - very good)
If a student has poor health, they might stay home from school more and have to miss class for appointments etc, this could lead to lower grades in theory. 
30 absences - number of school absences (numeric: from 0 to 93)
The number of absences can correlate with student performance.
The data set we are using describes grades based on three periods of the year: G1, G2, G3. It also lists other identifiers of students including sex, family size, occupation, etc. There are many different types of data, such as numeric, binary, and nominal. We will be using these identifiers as predictors for our analysis. Using the data, we want to explore which variables impact students' grades the most and use that information to predict whether a student will be successful in a course. In order to do this, we want to create a model using G3 as our response variable and the variables we find as statistically significant as our predictors in order to predict student success. Using this model, we can answer this question: What factors influence student grades and use those factors to predict future student grades? 
We also ask these questions: can we find a pattern to the students who dropped out, can G1 grades be used to predict which students dropped out and are there potentially other factors? This data is important as in the case of our data Portugal they have a high failure rate in core classes compared to other european countries. If we can identify the students who are most likely to drop out after first quarter then teachers and the school systems can provide additional resources to the student. 
The data comes from schools in Portugal through school records as well as questionnaires. This data was collected by Paulo Cortez and Alice Silva who work for the department of Information Systems/Algoritmi R&D Centre at the University of Minho. It started off as two datasets, one with student grades and another with the student questionnaire responses. It was then combined before doing analysis. This study is significant as specifically in Portugal, the proportion of students leaving class early is 40% whereas the average in the rest of the European Union is 15%. This is just one example of a statistic where Portugal is near the bottom compared to the rest of the European Union. Pinpointing a few of these factors could help officials develop a solution to improve Portugal’s educational performance.
One considerable challenge we faced so far was finding a sufficient dataset to answer statistical questions. A common issue we ran across was finding a balance between dataset size and content of the data. We came to an understanding that our data needed to have variables that shared a mix of binary and numeric values to answer questions that regarded estimation and prediction. Finding a dataset with enough variables to analyze relationships between was also a necessity. Our initial approach of using pairs plots to view relationships between variables ended up being insufficient due to the large number of variables we are analyzing together. To solve this problem, we decided to take an enhanced view at select variables. We felt that in doing so, our statistical questions will be answered with greater accuracy. 
Moving into December, here are our specific next steps.
We want to try running an initial regression model to see what the naive prediction is.
We will continue to collaborate and start to do some starting aspects of the project, for instance, using what we learned and reviewed in HW04, and applying those techniques to the project.  We will be applying PCA to our bolded variables and the methods we learned in class to determine which variables impact student performance the most.
Create a lm using predictions on Grades 1 and 2 to predict 3
Create lm to see if there is correlation between if parents have a college degree and impacts if students want to go to college.
See if there is a correlation between students who receive aid and if they want to pursue a college education. 


```{r,warning=FALSE}
library(tidyverse)
library(formattable)
data <- read.csv("student-mat.csv")
head(data,3)
```


```{r}
grades <- data %>% select(G1,G2,G3)
pairs(grades)
cor(grades)
```
```{r}
lmG1 <- lm(G3~G1,data = grades)
lmG2 <- lm(G3~G2,data = grades)
pc <- prcomp(grades[,c(1,2)], scale=TRUE)
lm <- lm(grades$G3 ~ pc$x[,1])
summary(lmG1)
summary(lmG2)
summary(lm)
```

```{r}
sum(residuals(lm)^2)
sum(residuals(lmG1)^2)
sum(residuals(lmG2)^2)
```
```{r}
plot(residuals(lm),xlab="Data Entry Index", ylab="Residual of Lm(G3~PC1)")
abline(h=0,col = "red")
```
There seems to be a strong correlation between the grades students had at the beginning of the year, the middle and the end. This was expected from our data. A linear model seems to be appropriate although when looking at the residual graph there are several outliers on the negative end. This is a pattern to further explore.
```{r}
cols <- character(nrow(grades))
cols[] <- "black"
cols[grades$G3 == 0] <- "red"
pairs(grades,col=cols)

plot(residuals(lm),xlab="Data Entry Index", ylab="Residual of Lm(G3~PC1)",col = cols)
abline(h=0,col = "red")
```
Based on the graphs above we are able to explain the data points that go against the trend of our data. The points in red represent students who got a 0 for their end of the year grade. We can assume those people dropped out after G1 or G2 was reported.

__Analysis of Students Who Dropped__
```{r}
drop <- data %>%
  mutate(dropped = case_when(
    G3 == 0 ~ 1,
    G3 > 0 ~ 0),
    G1=G1/20,G2=G2/20,G3=G3/20) %>%
  select(dropped,G1,G2,G3,everything())
head(drop,3)
```

We know there is a correlation between G1, G2, and G3, but can we find a pattern to the students who dropped out? Can G1 grades be used to predict which students dropped out? Are there potentially other factors? 

```{r}
drop %>% group_by(dropped) %>% summarise(count = n()) %>%
  mutate(freq = formattable::percent(count / sum(count)))
```

These questions are important to ask since if we can identify which students are most likely to drop out then analysis can be done on future students and those students who are most likely in danger of dropping out can receive access and resources to additional assistance. This is especially important to our data set when the Portuguese are trying to improve there student failure rate in core classes. Our data set shows that at the time of data collection there was about a 10% drop out rate which is very high. 

```{r}
drop %>%
  filter(dropped == 1) %>%
  ggplot(aes(G1)) +
  geom_bar() +
  xlab("First Period Grade in Percentage") +
  ylab("Student Count") +
  ggtitle("First Period Grades Among Students Who Dropped")
```

From these two graphs, we can see that among those who dropped at some point in the class, none of them were able to obtain a score higher than ~60%. Now, how does that relate to students who did not drop?

```{r}
ggplot(drop, aes(x=G1, group=dropped, fill=dropped)) +
  geom_density(alpha=.25) +
  xlab("First Period Grade in Percentage") +
  ylab("Density") +
  ggtitle("First Period Grade Density By Dropped Out")

ggplot(drop,aes(x=dropped, y=G1,group=dropped,fill=dropped)) + 
  geom_boxplot() +
  ggtitle("First Period Grade Distribution by Dropped Out")+
  xlab("Students Dropped Out By End of Year")+
  ylab("First Period Grade in Percentage")
```
Compared to students who did not drop the class, we see a noticeable difference between first period grades. While only the highest scoring students among the dropped category were able to score ~60%, the mean of all student's scores during the first period was ~60%. Thus, we can conclude that students that dropped the class can be predicted to do considerably worse than those who did not drop the class. This seems pretty obvious, but could there be other factors that lead to this outcome?

```{r}
predictDropOut <- glm(dropped~G1, data=drop, family="binomial")
summary(predictDropOut)
predict(predictDropOut, newdata=data.frame(G1=0.35), type="response")
```
We see that G1 is statistically significant at predicting if a student will drop out or not. 
Based on the first graph we see the averaged drop out grade seems to be around 35% when putting that into our model we get that our predicted percentage of dropping out is 24%. I was expecting this value to be higher. Maybe other factors can be included for a better prediction. Also how does the distribution of percentages look for our data?

__Modifying Data From Categorical to Representation by Numbers__
```{r}
data2 <- data %>% mutate(address = case_when(address == "U"~ 0,TRUE ~ 1),
                         famsup = case_when(famsup == "no"~0,TRUE~1),
                         higher = case_when(higher == "yes"~ 0, higher == "no" ~ 1),
                         internet = case_when(internet == "yes" ~ 0, internet == "no" ~ 1),
                         famsize = case_when(famsize == "GT3" ~ 0, famsize == "LE3" ~ 1),
                         Pstatus = case_when(Pstatus == "A" ~ 0, famsize == "T" ~ 1),
                         romantic = case_when(romantic == "no" ~ 0, romantic=="yes" ~ 1))%>%
  rename(motherEduation = Medu, fatherEduation = Fedu, parentalStatus=Pstatus)
data2
```

__Analysis of Factors That May Impact Final Grade Prediction__
```{r}
data2 %>% 
  ggplot(aes(x=sex, y=G3,fill=sex)) + 
    geom_boxplot() +
  ggtitle("Final Grades Based On Gender")+
  xlab("Gender(F=Female,M=Male)")+
  ylab("End Of Year Grade")
```

We see that on average males performed better in the math course over females. Being a male is more likely to lead to higher grades.

```{r}
data %>%
  ggplot(aes(x=famsup, y=G3,fill=famsup)) + 
    geom_boxplot() +
  ggtitle("Final Grades Based On Family Education Support")+
  xlab("Recieved Family Education Support")+
  ylab("End Of Year Grade")
```

This was surprising as we would have assumed if students received help at home they would receive higher grades due to that extra assistants. Our boxplot shows that both groups have the same average grade. The students who didn't receive help had a greater variety in Q3 and The students who did receive help on the other hand had greater variety in Q2. This being said we came to the conclusion that recieving help a home has minimal impact on final grades. 

```{r}
# data %>% mutate(studytime = case_when(studytime == 1 ~ "<15 min",
#                                       studytime == 2 ~ "15 to 30 min",
#                                       studytime == 3 ~ "30 min. to 1 hour",
#                                       TRUE ~ ">1 hour")) %>%
#   ggplot(aes(x=reorder(studytime,G3,na.rm = TRUE), y=G3,fill=studytime)) + 
#     geom_boxplot() +
#   ggtitle("Final Grades Based Weekly Study Time")+
#   xlab("Weekly Study Time")+
#   ylab("End Of Year Grade")

data %>% mutate(studytime = case_when(studytime == 1 ~ "<15 min",
                                      studytime == 2 ~ "<30 min",
                                      studytime == 3 ~ "<60 min",
                                      TRUE ~ "<60+ min")) %>% 
  ggplot(aes(x=studytime, y=G3,fill=studytime)) + 
    geom_boxplot() +
  ggtitle("Final Grades Based Weekly Study Time")+
  xlab("Weekly Study Time")+
  ylab("End Of Year Grade")
```

When looking at this graph we observed that as study time increases so does the average grade although overstudying can be a thing. Over an hour studying was still relatively comparable to 30min-1 hour studying by median but the lower 50 percent was spread out over a greater region on the other hand the top percentile received a higher grade then the top percentile of people who studied 30 minutes to an hour. Given this information we would say that 30 minutes to an hour is the optimal study time per week for this math course.

```{r}
data_onehot = data %>%
  mutate(m_sex = case_when(
  sex == "M" ~ 1,
  sex == "F" ~ 0)) %>%
  select(-sex) %>%
  mutate(study15 = case_when(
  studytime == 1 ~ 1,
  TRUE ~ 0)) %>%
  mutate(study30 = case_when(
  studytime == 2 ~ 1,
  TRUE ~ 0)) %>%
  mutate(study60 = case_when(
  studytime == 3 ~ 1,
  TRUE ~ 0)) %>% 
  mutate(study60_plus = case_when(
  studytime == 4 ~ 1,
  TRUE ~ 0)) %>% select(-studytime)
```
